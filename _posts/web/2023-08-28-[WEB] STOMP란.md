---
layout: single
title: "ğŸ“˜[WEB] STOMPë€?/SpringBootë¡œ ì±„íŒ… êµ¬í˜„"
toc: true
toc_sticky: true
toc_label: "ëª©ì°¨"
categories: web, spring
excerpt: ""
tag: [stomp]
---

# STOMP
**STOMP**ëŠ” **Simple/Stream Text Oriented Message Protocol**ì˜ ì•½ìë¡œ, ë©”ì‹œì§€ ì „ì†¡ì„ íš¨ìœ¨ì ìœ¼ë¡œ í•˜ê¸° ìœ„í•´ ë‚˜ì˜¨ í”„ë¡œí† ì½œì´ë‹¤.  
ê¸°ë³¸ì ìœ¼ë¡œ `pub/sub` êµ¬ì¡°ë¡œ ë˜ì–´ìˆì–´ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•˜ê³ , ë©”ì‹œì§€ë¥¼ ë°›ì•„ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì´ í™•ì‹¤íˆ ì •í•´ì ¸ìˆê¸° ë•Œë¬¸ì— ê°œë°œí•˜ëŠ” ì…ì¥ì—ì„œ ëª…í™•í•˜ê²Œ ì¸ì§€í•˜ê³  ê°œë°œí•  ìˆ˜ ìˆëŠ” ì´ì ì´ ìˆë‹¤.  
<br>

STOMPëŠ” `ì›¹ì†Œì¼“(WebSocket)` ìœ„ì—ì„œ ë™ì‘í•˜ë©°, httpì™€ ë§ˆì°¬ê°€ì§€ë¡œ `frame`ì„ ì‚¬ìš©í•´ ì „ì†¡í•˜ëŠ” í”„ë¡œí† ì½œì´ë‹¤.   
í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ì „ì†¡í•  ë©”ì‹œì§€ì˜ ìœ í˜•, í˜•ì‹, ë‚´ìš©ë“¤ì„ ì •ì˜í•˜ëŠ” ë§¤ì»¤ë‹ˆì¦˜ì´ë‹¤.  
<br>

ë˜í•œ stompë¥¼ ì´ìš©í•˜ë©´ í†µì‹  ë©”ì‹œì§€ì˜ í—¤ë”ì˜ ê°’ì„ ì„¸íŒ…í•  ìˆ˜ ìˆì–´ í—¤ë” ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ í†µì‹  ì‹œ ì¸ì¦ì²˜ë¦¬ë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤ê³  í•œë‹¤.  

## Frame?
`Frame`ì€ ëª…ë ¹(Command)ê³¼ ì¶”ê°€ì ì¸ í—¤ë”(Header)ì™€ ì¶”ê°€ì ì¸ ë°”ë””(Body)ë¡œ êµ¬ì„±ëœë‹¤.  
Frameì€ ëª‡ ê°œì˜ í…ìŠ¤íŠ¸ ë¼ì¸ìœ¼ë¡œ ì§€ì •ëœ êµ¬ì¡°ì¸ë°, ì²« ë²ˆì§¸ ë¼ì¸ì€ í…ìŠ¤íŠ¸(Command ëª…ë ¹ì–´)ê³ , ì´í›„ key:value í˜•íƒœë¡œ header ì •ë³´ë¥¼ í¬í•¨í•œë‹¤.  
header ì´í›„ì— ê³µë°± ì¤„ì„ í•˜ë‚˜ ë” ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ headerì˜ ëì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.  
header ì´í›„ì—ëŠ” Payload(Body)ê°€ ì¡´ì¬í•˜ê³ , ì´ëŠ” ì „ì†¡ë˜ëŠ” ë°ì´í„°ë¥¼ ì˜ë¯¸í•œë‹¤.  
<br>

[ì˜ˆì‹œ]  
```
COMMAND 
header1:value1 
header2:value2 

Body^@
```

## SpringBoot & STOMPë¥¼ ì´ìš©í•œ ì±„íŒ… êµ¬í˜„
### build.gradle
```
plugins {
    id 'org.springframework.boot' version '2.1.5.RELEASE'
    id 'java'
}

apply plugin: 'io.spring.dependency-management'

group = 'com.spring'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '1.8'

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-freemarker'
    implementation 'org.springframework.boot:spring-boot-devtools'
    implementation 'org.webjars.bower:bootstrap:4.3.1'
    implementation 'org.webjars.bower:vue:2.5.16'
    implementation 'org.webjars.bower:axios:0.17.1'
    implementation 'org.webjars:sockjs-client:1.1.2'
    implementation 'org.webjars:stomp-websocket:2.3.3-1'
    implementation 'com.google.code.gson:gson:2.8.0'

    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}
```  

### application.yml
```
spring:
  devtools:
    livereload:
      enabled: true
    restart:
      enabled: false
  freemarker:
    cache: false
```  

### application.properties
```
spring.devtools.livereload.enabled=true
spring.devtools.restart.enabled=false
spring.freemarker.cache=false
```  

### WebSockConfig ìˆ˜ì •
Stompë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `@EnableWebSocketMessageBroker`ë¥¼ ì„ ì–¸í•˜ê³ , `WebSocketMessageBrokerConfigurer`ë¥¼ ìƒì†ë°›ì•„ `configureMessageBroker`ë¥¼ êµ¬í˜„í•œë‹¤.  
ë©”ì‹œì§€ë¥¼ êµ¬ë…í•˜ëŠ” ìš”ì²­ì˜ `prefix/sub`ë¡œ, stomp websocket connection endpointëŠ” `/ws-stomp`ë¡œ ì„¤ì •í•œë‹¤.  

ì¦‰, ê°œë°œ ì„œë²„ì˜ ì ‘ì† ì£¼ì†ŒëŠ” *ws://localhost:8080/ws-stomp* ê°€ ëœë‹¤.  

```
@Configuration
@EnableWebSocketMessageBroker
public class WebSockConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/sub");
        config.setApplicationDestinationPrefixes("/pub");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws-stomp").setAllowedOrigins("*")
                .withSockJS();
    }
}
```

### ChatRoom ìˆ˜ì • (DTO)
pub/sub ë°©ì‹ì„ ì´ìš©í•˜ë©´ êµ¬ë…ì ê´€ë¦¬ê°€ ì•Œì•„ì„œ ë˜ë¯€ë¡œ, ì›¹ì†Œì¼“ ì„¸ì…˜ ê´€ë¦¬ê°€ í•„ìš” ì—†ì–´ì§„ë‹¤.  
ë˜, ë°œì†¡ì˜ êµ¬í˜„ë„ ì•Œì•„ì„œ í•´ê²°ë˜ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•˜ëŠ” êµ¬í˜„ì´ í•„ìš” ì—†ì–´ì§„ë‹¤.  
```
@Getter
@Setter
public class ChatRoom {
    private String roomId;
    private String name;

    public static ChatRoom create(String name) {
        ChatRoom chatRoom = new ChatRoom();
        chatRoom.roomId = UUID.randomUUID().toString();
        chatRoom.name = name;
        return chatRoom;
    }
}
```  

### ChatRoomRepository ìƒì„±
```
package com.spring.wschat.repo;

// import ìƒëµ....

@Repository
public class ChatRoomRepository {

    private Map<String, ChatRoom> chatRoomMap;

    @PostConstruct
    private void init() {
        chatRoomMap = new LinkedHashMap<>();
    }

    public List<ChatRoom> findAllRoom() {
        // ì±„íŒ…ë°© ìƒì„±ìˆœì„œ ìµœê·¼ ìˆœìœ¼ë¡œ ë°˜í™˜
        List chatRooms = new ArrayList<>(chatRoomMap.values());
        Collections.reverse(chatRooms);
        return chatRooms;
    }

    public ChatRoom findRoomById(String id) {
        return chatRoomMap.get(id);
    }

    public ChatRoom createChatRoom(String name) {
        ChatRoom chatRoom = ChatRoom.create(name);
        chatRoomMap.put(chatRoom.getRoomId(), chatRoom);
        return chatRoom;
    }
}
```  

### ChatController ìˆ˜ì •
`@MessageMapping`ì„ í†µí•´ ì›¹ì†Œì¼“ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë©”ì‹œì§€ ë°œí–‰ì„ ì²˜ë¦¬í•œë‹¤.  
í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” prefixë¥¼ ë¶™ì—¬ /pub/chat/messageë¡œ ë°œí–‰ì„ ìš”ì²­í•˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ë°›ì•„ ì²˜ë¦¬í•œë‹¤.  
ë©”ì‹œì§€ê°€ ë°œí–‰ë˜ë©´ /sub/chat/room/{roomId}ë¡œ ë©”ì‹œì§€ë¥¼ sendí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆëŠ”ë°, í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” í•´ë‹¹ ì£¼ì†Œë¥¼ (/sub/chat/room/{roomId}) êµ¬ë…í•˜ê³  ìˆë‹¤ê°€ ë©”ì‹œì§€ê°€ ì „ë‹¬ë˜ë©´ í™”ë©´ì— ì¶œë ¥í•œë‹¤.  
```
@RequiredArgsConstructor
@Controller
public class ChatController {

    private final SimpMessageSendingOperations messagingTemplate;

    @MessageMapping("/chat/message")
    public void message(ChatMessage message) {
        if (ChatMessage.MessageType.JOIN.equals(message.getType()))
            message.setMessage(message.getSender() + "ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
        messagingTemplate.convertAndSend("/sub/chat/room/" + message.getRoomId(), message);
    }
}
```

### êµ¬ë…ì(Subscriber) êµ¬í˜„
ì„œë²„ ë‹¨ì—ì„œëŠ” ë”°ë¡œ êµ¬í˜„í•  í•„ìš”ê°€ ì—†ë‹¤.  
ì›¹ ë·°ì—ì„œ stomp ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ êµ¬ë…ì ì£¼ì†Œë¥¼ ë°”ë¼ë³´ê³  ìˆëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ ëœë‹¤.  


### ChatRoomController ìƒì„±
```
@RequiredArgsConstructor
@Controller
@RequestMapping("/chat")
public class ChatRoomController {

    private final com.spring.wschat.repo.ChatRoomRepository chatRoomRepository;

    // ì±„íŒ… ë¦¬ìŠ¤íŠ¸ í™”ë©´
    @GetMapping("/room")
    public String rooms(Model model) {
        return "/chat/room";
    }
    // ëª¨ë“  ì±„íŒ…ë°© ëª©ë¡ ë°˜í™˜
    @GetMapping("/rooms")
    @ResponseBody
    public List<ChatRoom> room() {
        return chatRoomRepository.findAllRoom();
    }
    // ì±„íŒ…ë°© ìƒì„±
    @PostMapping("/room")
    @ResponseBody
    public ChatRoom createRoom(@RequestParam String name) {
        return chatRoomRepository.createChatRoom(name);
    }
    // ì±„íŒ…ë°© ì…ì¥ í™”ë©´
    @GetMapping("/room/enter/{roomId}")
    public String roomDetail(Model model, @PathVariable String roomId) {
        model.addAttribute("roomId", roomId);
        return "/chat/roomdetail";
    }
    // íŠ¹ì • ì±„íŒ…ë°© ì¡°íšŒ
    @GetMapping("/room/{roomId}")
    @ResponseBody
    public ChatRoom roomInfo(@PathVariable String roomId) {
        return chatRoomRepository.findRoomById(roomId);
    }
}
```

### ì±„íŒ…í™”ë©´ ìƒì„±
ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸, ì±„íŒ…ë°© ìƒì„¸ í™”ë©´ viewë¥¼ ìƒì„±í•œë‹¤.  
`/resources/templates/`ì— room.ftl, roomdetail.ftl íŒŒì¼ì„ ìƒì„±í•œë‹¤.  

#### room.ftl
```
<!doctype html>
<html lang="en">
  <head>
    <title>Websocket Chat</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- CSS -->
    <link rel="stylesheet" href="/webjars/bootstrap/4.3.1/dist/css/bootstrap.min.css">
    <style>
      [v-cloak] {
          display: none;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app" v-cloak>
        <div class="row">
            <div class="col-md-12">
                <h3>ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸</h3>
            </div>
        </div>
        <div class="input-group">
            <div class="input-group-prepend">
                <label class="input-group-text">ë°©ì œëª©</label>
            </div>
            <input type="text" class="form-control" v-model="room_name" v-on:keyup.enter="createRoom">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" @click="createRoom">ì±„íŒ…ë°© ê°œì„¤</button>
            </div>
        </div>
        <ul class="list-group">
            <li class="list-group-item list-group-item-action" v-for="item in chatrooms" v-bind:key="item.roomId" v-on:click="enterRoom(item.roomId)">
                {{item.name}}
            </li>
        </ul>
    </div>
    <!-- JavaScript -->
    <script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
    <script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                room_name : '',
                chatrooms: [
                ]
            },
            created() {
                this.findAllRoom();
            },
            methods: {
                findAllRoom: function() {
                    axios.get('/chat/rooms').then(response => { this.chatrooms = response.data; });
                },
                createRoom: function() {
                    if("" === this.room_name) {
                        alert("ë°© ì œëª©ì„ ì…ë ¥í•´ ì£¼ì‹­ì‹œìš”.");
                        return;
                    } else {
                        var params = new URLSearchParams();
                        params.append("name",this.room_name);
                        axios.post('/chat/room', params)
                        .then(
                            response => {
                                alert(response.data.name+"ë°© ê°œì„¤ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.")
                                this.room_name = '';
                                this.findAllRoom();
                            }
                        )
                        .catch( response => { alert("ì±„íŒ…ë°© ê°œì„¤ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤."); } );
                    }
                },
                enterRoom: function(roomId) {
                    var sender = prompt('ëŒ€í™”ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                    if(sender != "") {
                        localStorage.setItem('wschat.sender',sender);
                        localStorage.setItem('wschat.roomId',roomId);
                        location.href="/chat/room/enter/"+roomId;
                    }
                }
            }
        });
    </script>
  </body>
</html>
```

#### roomdetail.ftl
```
<!doctype html>
<html lang="en">
  <head>
    <title>Websocket ChatRoom</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/webjars/bootstrap/4.3.1/dist/css/bootstrap.min.css">
    <style>
      [v-cloak] {
          display: none;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app" v-cloak>
        <div>
            <h2>{{room.name}}</h2>
        </div>
        <div class="input-group">
            <div class="input-group-prepend">
                <label class="input-group-text">ë‚´ìš©</label>
            </div>
            <input type="text" class="form-control" v-model="message" v-on:keypress.enter="sendMessage">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" @click="sendMessage">ë³´ë‚´ê¸°</button>
            </div>
        </div>
        <ul class="list-group">
            <li class="list-group-item" v-for="message in messages">
                {{message.sender}} - {{message.message}}</a>
            </li>
        </ul>
        <div></div>
    </div>
    <!-- JavaScript -->
    <script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
    <script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
    <script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
    <script>
        //alert(document.title);
        // websocket & stomp initialize
        var sock = new SockJS("/ws-stomp");
        var ws = Stomp.over(sock);
        var reconnect = 0;
        // vue.js
        var vm = new Vue({
            el: '#app',
            data: {
                roomId: '',
                room: {},
                sender: '',
                message: '',
                messages: []
            },
            created() {
                this.roomId = localStorage.getItem('wschat.roomId');
                this.sender = localStorage.getItem('wschat.sender');
                this.findRoom();
            },
            methods: {
                findRoom: function() {
                    axios.get('/chat/room/'+this.roomId).then(response => { this.room = response.data; });
                },
                sendMessage: function() {
                    ws.send("/pub/chat/message", {}, JSON.stringify({type:'TALK', roomId:this.roomId, sender:this.sender, message:this.message}));
                    this.message = '';
                },
                recvMessage: function(recv) {
                    this.messages.unshift({"type":recv.type,"sender":recv.type=='ENTER'?'[ì•Œë¦¼]':recv.sender,"message":recv.message})
                }
            }
        });

        function connect() {
            // pub/sub event
            ws.connect({}, function(frame) {
                ws.subscribe("/sub/chat/room/"+vm.$data.roomId, function(message) {
                    var recv = JSON.parse(message.body);
                    vm.recvMessage(recv);
                });
                ws.send("/pub/chat/message", {}, JSON.stringify({type:'ENTER', roomId:vm.$data.roomId, sender:vm.$data.sender}));
            }, function(error) {
                if(reconnect++ <= 5) {
                    setTimeout(function() {
                        console.log("connection reconnect");
                        sock = new SockJS("/ws-stomp");
                        ws = Stomp.over(sock);
                        connect();
                    },10*1000);
                }
            });
        }
        connect();
    </script>
  </body>
</html>
```


# ì°¸ê³ ìë£Œ
[https://velog.io/@qkrqudcks7/STOMP%EB%9E%80](https://velog.io/@qkrqudcks7/STOMP%EB%9E%80)  
[https://www.daddyprogrammer.org/post/4691/spring-websocket-chatting-server-stomp-server/](https://www.daddyprogrammer.org/post/4691/spring-websocket-chatting-server-stomp-server/)  
[WebSocket ê³µì‹ë¬¸ì„œ](https://developer.mozilla.org/ko/docs/Web/API/WebSocket)  