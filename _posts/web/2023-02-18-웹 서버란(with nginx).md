---
layout: single
title: "📘[Web] 웹 서버란 [Apache, Nginx]"
toc: true
toc_sticky: true
toc_label: "목차"
categories: web
excerpt: ""
tag: [server]
---

# 웹 서버란?
흔히 우리가 웹서버라고 하면 다음 두가지 중 하나를 의미함.   

소프트웨어적 관점
: 브라우저와 같은 클라이언트로부터 http 요청을 받고, html 문서와 같은 웹 페이지를 반환하는 `컴퓨터 프로그램`

하드웨어적 관점
: 소프트웨어적 관점에서 동작하는 기능을 수행하는 `물리적 컴퓨터`

## Apache(아파치)
`아파치`는 아파치 소프트웨어 재단에서 개발하고 관리하는 무료 http 웹 서버 소프트웨어임.  
기본적인 동작 방식은 사용자의 http요청이 올 때마다 프로세스나 스레드를 새로 생성함.  
`단일 요청 - 단인 스레드/프로세스`이므로, 사용자의 요청이 많아질 수록 메모리를 많이 차지한다는 단점이 있다.  
그러다보면, 하나의 CPU가 여러 프로세스를 맡아 처리해야 하므로 부하가 많아질 수가 있다.  

### Apache 동작 방식
**Prefork MPM(Multi Processing Module)방식**  
- http 요청이 올 때마다 프로세스를 매번 `복제`해서 프로세스에서 싱글 스레드로 사용자 요청을 처리함.  
  - 사용자 요청 = 프로세스 개수

**Worker MPM방식**  
`한 개의 프로세스가 여러 스레드를 생성`하여 해당 HTTP 요청을 처리하므로 `Prefork 방식보다 메모리 소모가 적음`.  
하지만 멀티 스레드 방식은 CPU 스케줄링을 위한 처리 시간과 문맥 전환 비용이 발생하는 단점이 있다.  
스레드를 분배하기 위해 사용되는 CPU 스케줄링에 대한 연산 작업과 쓰레드 간의 전환을 위해 전환하기 직전의 쓰레드를 나중에 복귀시킬 때를 대비하여 
상태를 저장해두기 위한 CPU 연산 작업으로 인해 스레드가 많아질수록 성능 저하가 발생함.  


## Nginx(엔진엑스)
`Nginx`는 `웹 서버 소프트웨어`이다.  
사용자 요청에 응답하기 위해 `비동기 이벤트` 기반의 구조를 가진다.  
<br>

**비동기 이벤트**  
http요청이 수 천개와 같이 많이 들어와도 정해진 수의 프로세스가 이 요청들을 이벤트로 등록하고 비동기 방식으로 대기시켜 완료되는 요청부터 처리(응답)해주는 것을 말함.  

### Nginx 동작 방식
NGINX에서는 커넥션 생성 및 커넥션 제거, 그리고 새로운 요청을 처리하는 것을 `이벤트`라고 부른다.  
이 이벤트들은 OS커널이 큐 형식으로 worker 프로세스에게 전달해주고, 이벤트가 큐에 담긴 상태에서 worker 프로세스가 처리할 때까지 비동기 방식으로 대기한다.  
그리고 워커 프로세스는 하나의 스레드로 이벤트를 꺼내서 처리해 나간다.   
이렇게 되면 워커 프로세스가 쉴틈없이 일하기 때문에 아파치 서버에서 요청이 없다면 방치되던 프로세스보다 서버 자원을 더 효율적으로 쓸 수 있게 되는 것이다.   
그러나 네모 칸(큐)에 있는 요청(이벤트) 중 하나가 시간이 오래걸리는 작업(ex. Disk I/O)이면 어떻게 될까?  
그 뒤에 있는 이벤트는 요청을 처리하는 긴 시간동안 블로킹이 된다.  
그래서 NGINX는 시간이 오래 걸리는 작업은 따로 수행하는 스레드 풀(Thread Pool)을 만들어놓고, 
워커 프로세스는 지금 처리할 요청이 시간이 많이 걸릴 것 같다면 스레드 풀에 그 이벤트를 위임하고 큐 안에 있는 다른 이벤트를 처리하러 가게 된다.  